# Verify a ZK Proof in Cartesi Machine

In this section, we'll create a RISC-V compatible verifier that runs inside a Cartesi Machine to validate our zero-knowledge proofs. The verifier will check both the proof's validity and ensure it was generated by our specific program.

Before we begin, make sure you have Cartesi Machine installed:

```bash
cartesi-machine --version
```

## 1. Setup Project Structure

Let's create a clean workspace for our verifier:

```bash
mkdir -p cartesi-verifier/drives/input
cd cartesi-verifier
cargo new verifier
cd verifier
```

The `drives/input` directory will be mounted inside our Cartesi Machine, making our files accessible during verification.

## 2. Configure Dependencies

Our verifier needs a few key dependencies. Add them to your `verifier/Cargo.toml`:

```toml
[package]
name = "verifier"
version = "0.1.0"
edition = "2021"

[dependencies]
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"
bincode = "1.3"
base64 = "0.21"
risc0-zkvm = { version = "1.2.1", default-features = false } # Disable default features for WASM
```

## 3. Write the Verifier Code

The verifier needs to read and validate our proof file. Create this code in `verifier/src/main.rs`:

```rust
use base64::{engine::general_purpose::STANDARD as BASE64, Engine as _};
use bincode::deserialize;
use risc0_zkvm::Receipt;
use serde::Deserialize;
use std::fs::File;
use std::io::Read;

#[derive(Deserialize)]
struct ProofData {
    receipt: String,
    image_id: String,
}

fn main() {
    // Read the JSON proof file
    let mut proof_file =
        File::open("/mnt/input/proof.json").expect("Failed to open proof.json file");
    let mut proof_contents = String::new();
    proof_file
        .read_to_string(&mut proof_contents)
        .expect("Failed to read proof.json");

    // Parse the JSON data
    let proof_data: ProofData =
        serde_json::from_str(&proof_contents).expect("Failed to parse proof JSON");

    // Decode the base64 receipt
    let receipt_data = BASE64
        .decode(proof_data.receipt)
        .expect("Failed to decode receipt base64");
    let receipt: Receipt = deserialize(&receipt_data).expect("Failed to deserialize receipt");

    // Decode the base64 image ID
    let id_data = BASE64
        .decode(proof_data.image_id)
        .expect("Failed to decode image ID base64");
    let image_id: [u8; 32] = id_data.try_into().expect("Image ID has incorrect length");

    // Verify the proof
    match receipt.verify(image_id) {
        Ok(_) => println!("Hi buddy! Proof verification inside the Cartesi Machine was successful! The receipt is valid!"),
        Err(e) => println!("Proof verification failed: {:?}", e)
    }
}
```

## 4. Cross-Compile for the Cartesi Machine

Since Cartesi Machine uses RISC-V architecture, we need to cross-compile our verifier:

- **Install the cross-compilation tools:**

  ```bash
  cargo install cross --git https://github.com/cross-rs/cross
  ```

- **Build the verifier for RISC-V:**

  ```bash
  cross build --target riscv64gc-unknown-linux-gnu --release
  ```

- **Copy the compiled binary to the input drive:**

  ```bash
  cp target/riscv64gc-unknown-linux-gnu/release/verifier ../drives/input/
  ```

## 5. Prepare Input File

:::note
You must copy the proof.json file from when you generated the proof.
:::

```bash
# Copy the proof file from your previous RISC Zero project
cp ../path/to/previous/proof.json ../drives/input/proof.json
```

This file is essential - it contains both the proof and program identifier from our previous step. Without this file, the verification will fail!

## 6. Create ext2 Filesystem Image

We need to package our files into a format that Cartesi Machine can read:

Install the ext2 filesystem tools:

```bash
# macOS
brew install genext2fs
# Linux
sudo apt-get install genext2fs
```

2. Generate the ext2 image:

```bash
cd ..
genext2fs -b 32768 -d drives/input drives/input.ext2
```

This creates a Linux-compatible filesystem containing our verifier and proof files.

### Expected Directory Structure

After preparing all the files, your project structure should look like this:

```
cartesi-verifier/
â”œâ”€â”€ drives/
â”‚   â”œâ”€â”€ input/
â”‚   â”‚   â”œâ”€â”€ verifier           # The cross-compiled RISC-V binary
â”‚   â”‚   â””â”€â”€ proof.json         # The proof data from previous step
â”‚   â””â”€â”€ input.ext2             # Generated filesystem image
â”œâ”€â”€ verifier/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â””â”€â”€ main.rs           # Verifier source code
â”‚   â”œâ”€â”€ target/               # Build artifacts
â”‚   â”‚   â””â”€â”€ riscv64gc-unknown-linux-gnu/
â”‚   â”‚       â””â”€â”€ release/
â”‚   â”‚           â””â”€â”€ verifier  # Original compiled binary
â”‚   â””â”€â”€ Cargo.toml
â””â”€â”€ Dockerfile
```

:::tip
Make sure all files in `drives/input/` are present before generating the ext2 image. You can verify with:

```bash
ls -l drives/input/
```

:::

## 7. Run the Cartesi Machine

Now for the exciting part - let's run our verifier inside Cartesi Machine:

```bash
cartesi-machine \
    --ram-length=128Mi \
    --flash-drive="label:input,filename:drives/input.ext2,length:32Mi,shared" \
    --flash-drive="label:output,length:4Ki,shared" \
    -i -- sh
```

Once inside the Cartesi Machine, run the verifier:

```bash
cd /mnt/input
./verifier
```

If everything is set up correctly, you'll see:

```
         .
        / \
      /    \
\---/---\  /----\
 \       X       \
  \----/  \---/---\
       \    / CARTESI
        \ /   MACHINE
         '

$ cd /mnt/input
$ ./verifier
Hi buddy! Proof verification inside the Cartesi Machine was successful! The receipt is valid!
```

This means your zero-knowledge proof has been successfully verified inside the Cartesi Machine! ðŸŽ‰

## Troubleshooting

- **"Failed to open proof.json file"**: Double-check that you copied `proof.json` from your previous step to `drives/input/`.
- **"Failed to parse proof JSON"**: Ensure the JSON file is properly formatted and contains both receipt and image_id fields.
- **Permission Issues**: Run `chmod +x drives/input/verifier` before creating the ext2 image.
- **Ext2 Image Errors**: Use `genext2fs -D` for detailed debugging information.
- **Verification Fails**: Ensure you're using the correct `proof.json` that matches your program - mixing files from different programs won't work!
